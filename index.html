<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
	<link rel="stylesheet" type="text/css" href="css/index.css" />
	<title>GeoSensor App</title>

	<script>
		// Redirect console.log to Evothings Workbench.
		if (window.hyper && window.hyper.log) {
			console.log = hyper.log;
		}
	</script>
</head>

<div class="main-container">
	<header class="header-container">
		<div class="img-container">
			<img src="resources/logo.png" alt="Logo app" />
		</div>

		<div class="title-container">
			<h1>GeoSensor App</h1>
			<p>Sensors monitorizations for rescue and emergency personnel</p>
		</div>
	</header>
	<div class="conection-container">
		<p>To connect device, press the button:</p>
		<div class="buttons-">
			<a class="connect-button" href="#"> Connect </a>
			<a class="disconnect-button" href="#">Disconnect</a>
		</div>
		<div class="status">
			<span>Status: </span>
			<span class="status-sensor">Disconnected</span>
		</div>
		<div class="status">
			<span>Log: </span>
			<span class="error-sensor"> - </span>
		</div>
	</div>
	<div class="sensors">
		<h2>Sensors:</h2>
		<div class="geolocation sensor">
			<div class="sensor-img-container">
				<img src="resources/geo.png" alt="geolocation img"></img>
			</div>
			<div class="sensor-name">
				<h4>Location</h4>
				<p id="lat-value">Lat: 0</p>
				<p id="lon-value">Lon: 0</p>
				<div class="geo-status">
					<span>Status: </span>
					<span class="status-sensor-geo">Disconnected</span>
				</div>
			</div>
		</div>
		<div class="luxometer sensor">
			<div class="sensor-img-container">
				<img src="resources/lux.png" alt="luxometer img"></img>
			</div>
			<div class="sensor-name">
				<h4>Luxometer</h4>
				<p id="lux-value">0 lux</p>
				<div class="lux-status">
					<span>Status: </span>
					<span id="status-sensor-lux">Disconnected</span>
				</div>
			</div>
		</div>
		<div class="button sensor">
			<div class="sensor-img-container">
				<img src="resources/button.png" alt="button img"></img>
			</div>
			<div class="sensor-name">
				<h4>button</h4>
				<p id="button-value">No pressed</p>
				<div class="button-status">
					<span>Status: </span>
					<span class="status-sensor-button"> - </span>
				</div>
			</div>
		</div>
		<div class="temperature sensor">
			<div class="sensor-img-container">
				<img src="resources/temperature.png" alt="temperature img"></img>
			</div>
			<div class="sensor-name">
				<h4>Temperature</h4>
				<p id="temperature-value">0 ÂºC</p>
				<div class="temperature-status">
					<span>Status: </span>
					<span id="status-sensor-temperature">Disconnected</span>
				</div>
			</div>
		</div>
		<div class="humidity sensor">
			<div class="sensor-img-container">
				<img src="resources/humidity.png" alt="humidity img"></img>
			</div>
			<div class="sensor-name">
				<h4>Humidity</h4>
				<p id="humidity-value">0 %RH</p>
				<div class="humidity-status">
					<span>Status: </span>
					<span id="status-sensor-humidity">Disconnected</span>
				</div>
			</div>
		</div>
		<div class="barometer sensor">
			<div class="sensor-img-container">
				<img src="resources/barometer.png" alt="barometer img"></img>
			</div>
			<div class="sensor-name">
				<h4>barometer</h4>
				<p id="barometer-value">0 mbar</p>
				<div class="barometer-status">
					<span>Status: </span>
					<span id="status-sensor-barometer">Disconnected</span>
				</div>
			</div>
		</div>
		<div class="gyro sensor">
			<div class="sensor-img-container">
				<img src="resources/gyro.png" alt="gyro img"></img>
			</div>
			<div class="sensor-name">
				<h4>Gyroscope</h4>
				<p id="gyro-valuex">X: 0</p>
				<p id="gyro-valuey">Y: 0</p>
				<p id="gyro-valuez">Z: 0</p>
				<div class="gyro-status">
					<span>Status: </span>
					<span id="status-sensor-gyro">Disconnected</span>
				</div>
			</div>
		</div>
		<div class="ace sensor">
			<div class="sensor-img-container">
				<img src="resources/ace.png" alt="acelerometer img"></img>
			</div>
			<div class="sensor-name">
				<h4>Acelerometer</h4>
				<p id="ace-valuex">X: 0 g</p>
				<p id="ace-valuey">Y: 0 g</p>
				<p id="ace-valuez">Z: 0 g</p>
				<div class="ace-status">
					<span>Status: </span>
					<span id="status-sensor-ace">Disconnected</span>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="cordova.js"></script>
<script src="libs/mqttws31-min.js"></script>
<script src="libs/jquery/jquery.js"></script>
<script src="libs/evothings/evothings.js"></script>
<script src="libs/evothings/ui/ui.js"></script>
<script src="libs/evothings/tisensortag/tisensortag.js"></script>
<script src="app.js"></script>
<script type="text/javascript" src="js/index.js"></script>

<script>
	// SensorTag object.
	var sensortag

		// Interval to send data to IBM Platform.
		var temperatureInterval = 6000;
	// Timer to send data.
	var temperatureTimer = null

	var lastLightReading = '0.0';
	var lastHumidityReading = '0.0';
	var lastTemperatureReading = '0.0';

	function initialiseSensorTag() {
		// Create SensorTag CC2650 instance.
		sensortag = evothings.tisensortag.createInstance(
			evothings.tisensortag.CC2650_BLUETOOTH_SMART)
		// Add sensors callbacks
		sensortag
			.statusCallback(statusHandler)
			.errorCallback(errorHandler)
			.keypressCallback(keypressHandler)
			//.temperatureCallback(temperatureHandler, 1000)
			.humidityCallback(humidityHandler, 1000)
			.barometerCallback(barometerHandler, 1000)
			.accelerometerCallback(accelerometerHandler, 1000)
			//.magnetometerCallback(magnetometerHandler, 1000)
			.gyroscopeCallback(gyroscopeHandler, 1000)
			.luxometerCallback(luxometerHandler, 1000)
	}

	function connect() {
		sensortag.connectToNearestDevice()
		// Clear existing interval timer if any.
		temperatureTimer && clearInterval(temperatureTimer)
		// Start the interval timer for uploading data. 
		temperatureTimer = setInterval(onTemperatureTimer, temperatureInterval)
	}

	function onTemperatureTimer() {
		// Save the temperature value to the Bluemix IoT Foundation cloud
		var evt = JSON.stringify({ambientTemp: lastTemperatureReading, humidity: lastHumidityReading, light: lastLightReading})
		//send to MQTT publish function
		app.publish(evt)
	}

	function disconnect() {
		sensortag.disconnectDevice()
		resetSensorDisplayValues()
	}

	function statusHandler(status) {
		$('.status-sensor').text("Connected");
	}

	function errorHandler(error) {
		$('.error-sensor').text(error);

		if (evothings.easyble.error.DISCONNECTED == error) {
			disconnect();
		}
		else {
			$('.error-sensor').text(error);
		}
	}

	function resetSensorDisplayValues() {
		// Clear current values.
		$('.status-sensor-button').text(" - ");
		displayValue('status-sensor-ace', "Disconnected");
		displayValue('status-sensor-temperature', "Disconnected");
		displayValue('status-sensor-humidity', "Disconnected");
		displayValue('status-sensor-gyro', "Disconnected");
		displayValue('status-sensor-barometer', "Disconnected");
		displayValue('status-sensor-lux', "Disconnected");
		$('.status-sensor').text("Disconnected");
	}

	function keypressHandler(data) {
		// Update background color.
		switch (data[0]) {
			case 0:
				// no pressed
				$('#button-value').text("No pressed");
				$(".button").css("background-color", "white");
				break;
			case 1:
				// Finished
				$('#button-value').text("Pressed");
				$(".button").css("background-color", "green");
				$('.status-sensor-button').text("Finished");
				break;
			case 2:
				// Found
				$('#button-value').text("Pressed");
				$(".button").css("background-color", "green");
				$('.status-sensor-button').text("Found");
				break;
			case 3:
				// Emergency
				$('#button-value').text("Pressed");
				$(".button").css("background-color", "red");
				$('.status-sensor-button').text("Emergency");
				break;
		}

		// Update the value displayed.
		var string = 'raw: 0x' + bufferToHexStr(data, 0, 1)
		displayValue('KeypressData', string)
	}

	/* function temperatureHandler(data) {
		// Calculate temperature from raw sensor data.
		var values = sensortag.getTemperatureValues(data)
		var ac = values.ambientTemperature
		var af = sensortag.celsiusToFahrenheit(ac)
		var tc = values.targetTemperature
		var tf = sensortag.celsiusToFahrenheit(tc)

		// Prepare the information to display.
		var string =
			//'raw: <span style="font-family: monospace;">0x' +
			//	bufferToHexStr(data, 0, 4) + '</span><br/>' +
			(tc >= 0 ? '+' : '') + tc.toFixed(2) + '&deg; C ' +
			'(' + (tf >= 0 ? '+' : '') + tf.toFixed(2) + '&deg; F)' + '<br/>' +
			(ac >= 0 ? '+' : '') + ac.toFixed(2) + '&deg; C ' +
			'(' + (af >= 0 ? '+' : '') + af.toFixed(2) + '&deg; F) [amb]' +
			'<br/>'

		// Update the value displayed.
		displayValue('TemperatureData', string)
	} */

	function accelerometerHandler(data) {
		// Calculate the x,y,z accelerometer values from raw data.
		var values = sensortag.getAccelerometerValues(data)
		var x = values.x
		var y = values.y
		var z = values.z

		//var model = sensortag.getDeviceModel()
		//var dataOffset = (model == 2 ? 6 : 0)

		// Prepare the information to display.
		stringX = (x >= 0 ? '+' : '') + x.toFixed(5) + 'G<br/>'
		stringY = (y >= 0 ? '+' : '') + y.toFixed(5) + 'G<br/>';
		stringZ = (z >= 0 ? '+' : '') + z.toFixed(5) + 'G<br/>';

		// Update the value displayed.
		displayValue('ace-valuex', stringX)
		displayValue('ace-valuey', stringY)
		displayValue('ace-valuez', stringZ)
		displayValue('status-sensor-ace', "Connected")
	}

	function humidityHandler(data) {
		// Calculate the humidity values from raw data.
		var values = sensortag.getHumidityValues(data)

		// Calculate the humidity temperature (C and F).
		var tc = values.humidityTemperature
		lastHumidityReading = tc.toFixed(2)
		lastTemperatureReading = tc.toFixed(2)
		//var tf = sensortag.celsiusToFahrenheit(tc)

		// Calculate the relative humidity.
		var h = values.relativeHumidity
		//lastHumidityReading = h;
		// Prepare the information to display.
		stringTemperature = tc.toFixed(2) + '&deg; C ';
		stringHumidity = h.toFixed(2) + '% RH'

		// Update the value displayed.
		displayValue('temperature-value', stringTemperature);
		displayValue('humidity-value', stringHumidity);
		displayValue('status-sensor-temperature', "Connected");
		displayValue('status-sensor-humidity', "Connected");
	}
	/*
		function magnetometerHandler(data) {
			// Calculate the magnetometer values from raw sensor data.
			var values = sensortag.getMagnetometerValues(data)
			var x = values.x
			var y = values.y
			var z = values.z
	
			//var model = sensortag.getDeviceModel()
			//var dataOffset = (model == 2 ? 12 : 0)
	
			// Prepare the information to display.
			string =
				//'raw: <span style="font-family: monospace;">0x' +
				//	bufferToHexStr(data, dataOffset, 6) + '</span><br/>' +
				'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + '&micro;T <br/>' +
				'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + '&micro;T <br/>' +
				'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + '&micro;T <br/>'
	
			// Update the value displayed.
			displayValue('MagnetometerData', string)
		}
		*/

	function barometerHandler(data) {
		// Calculate pressure from raw sensor data.
		var values = sensortag.getBarometerValues(data);
		var pressure = values.pressure;

		// Prepare the information to display.
		string = pressure.toPrecision(5) + ' mbar<br/>';

		// Update the value displayed.
		displayValue('barometer-value', string);
		displayValue('status-sensor-barometer', "Connected");
	}

	function gyroscopeHandler(data) {
		// Calculate the gyroscope values from raw sensor data.
		var values = sensortag.getGyroscopeValues(data);
		var x = values.x;
		var y = values.y;
		var z = values.z;

		// Prepare the information to display.
		stringx = (x >= 0 ? '+' : '') + x.toFixed(5);
		stringy = (y >= 0 ? '+' : '') + y.toFixed(5);
		stringz = (z >= 0 ? '+' : '') + z.toFixed(5);

		// Update the value displayed.
		displayValue('gyro-valuex', stringX);
		displayValue('gyro-valuey', stringY);
		displayValue('gyro-valuez', stringZ);
		displayValue('status-sensor-gyro', "Connected");
	}

	function luxometerHandler(data) {
		var value = sensortag.getLuxometerValue(data);
		lastLightReading = value.toPrecision(5);
		// Prepare the information to display.
		string = value.toPrecision(5) + ' lux<br/>';
		
		//hyper.log("Nueva: " + value)
		// Update the value displayed.
		displayValue('lux-value', string);
		displayValue('status-sensor-lux', "Connected");
	}

	function displayValue(elementId, value) {
		document.getElementById(elementId).innerHTML = value;
	}

	/**
	 * Convert byte buffer to hex string.
	 * @param buffer - an Uint8Array
	 * @param offset - byte offset
	 * @param numBytes - number of bytes to read
	 * @return string with hex representation of bytes
	 */
	function bufferToHexStr(buffer, offset, numBytes) {
		var hex = ''
		for (var i = 0; i < numBytes; ++i) {
			hex += byteToHexStr(buffer[offset + i])
		}
		return hex
	}

	/**
	 * Convert byte number to hex string.
	 */
	function byteToHexStr(d) {
		if (d < 0) { d = 0xFF + d + 1 }
		var hex = Number(d).toString(16)
		var padding = 2
		while (hex.length < padding) {
			hex = '0' + hex
		}
		return hex
	}

	// Connect Button:
	$(".connect-button").click(function (e) {
		e.preventDefault();
		$('.status-sensor').text("Connecting ...");
		connect();
	});
	// Disconnect Button:
	$(".disconnect-button").click(function (e) {
		e.preventDefault();
		disconnect();
		resetSensorDisplayValues();
	});

	document.addEventListener(
		'deviceready',
		function () { evothings.scriptsLoaded(initialiseSensorTag) },
		false)
</script>
</body>

</html>